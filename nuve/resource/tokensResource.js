"use strict";var dataAccess=require("../data_access"),crypto=require("crypto"),cloudHandler=require("../cloudHandler"),logger=require("./../logger").logger,e=require("../errors"),log=logger.getLogger("TokensResource"),getTokenString=function(a,s){return dataAccess.token.key().then(function(e){var r=a+","+s.host,o=crypto.createHmac("sha256",e).update(r).digest("hex"),t=new Buffer(o).toString("base64"),n={tokenId:a,host:s.host,secure:s.secure,signature:t};return new Buffer(JSON.stringify(n)).toString("base64")}).catch(function(e){log.error("Get nuveKey error:",e)})},generateToken=function(e,r,o,t){var n,a=r.service,s=r.user,i=r.role;void 0!==s&&""!==s&&r.room.roles.find(function(e){return e.role===i})?((n={}).user=s,n.room=e,n.role=i,n.service=a._id,n.creationDate=new Date,n.origin=o,n.code=Math.floor(1e11*Math.random())+"",n.secure=!1,cloudHandler.schedulePortal(n.code,o,function(e){"timeout"!==e?(n.secure=e.ssl,""!==e.hostname?n.host=e.hostname:n.host=e.ip,n.host+=":"+e.port,dataAccess.token.create(n,function(e){getTokenString(e,n).then(function(e){t(e)})})):t("error")})):t(void 0)};exports.create=function(o,t,n){var a=o.authData;a.user=o.authData.user||o.body&&o.body.user,a.role=o.authData.role||o.body&&o.body.role;var r=o.body&&o.body.preference||{isp:"isp",region:"region"};generateToken(o.params.room,a,r,function(r){return void 0===r?(log.info("Name and role?"),n(new e.BadRequestError("Name or role not valid"))):"error"===r?(log.info("CloudHandler does not respond"),n(new e.CloudError("Failed to get portal"))):(log.debug("Created token for room ",o.params.room,"and service ",a.service._id),void t.send(r))})};