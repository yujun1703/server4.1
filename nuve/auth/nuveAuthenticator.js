"use strict";var dataAccess=require("../data_access"),mauthParser=require("./mauthParser"),cipher=require("../cipher"),log=require("./../logger").logger.getLogger("NuveAuthenticator"),e=require("../errors"),cache={},checkTimestamp=function(e,r){if(!0!==(global.config||{}).timestampCheck)return!0;var t,a,i=e._id+"",n=cache[i],c=new Date(parseInt(r.timestamp,10)).getTime(),u=r.cnonce;return isNaN(c)?(log.debug("Invalid timestamp:",r.timestamp),!1):void 0===n||(t=new Date(parseInt(n.timestamp,10)).getTime(),a=n.cnonce,!(c<t||t===c&&a===u)||(log.info("Last timestamp: ",t," and new: ",c),log.info("Last cnonce: ",a," and new: ",u),!1))},checkSignature=function(e,r){return"HMAC_SHA256"===e.signature_method&&mauthParser.calculateClientSignature(e,r)===e.signature};exports.authenticate=function(i,r,n){var c,t=i.header("Authorization"),u=new e.AuthError('WWW-Authenticate: MAuth realm="http://marte3.dit.upm.es"');void 0!==t?(c=mauthParser.parseHeader(t),dataAccess.service.get(c.serviceid,function(e,r){if(e)return n(e);if(!r)return log.info("[Auth] Unknow service:",c.serviceid),n(u);var t=r.key;if(!0===r.encrypted&&(t=cipher.decrypt(cipher.k,t)),checkSignature(c,t)){var a={};void 0!==c.username&&void 0!==c.role&&(a.user=new Buffer(c.username,"base64").toString("utf8"),a.role=c.role),cache[r._id+""]=c,a.service=r,i.authData=a,n()}else log.info("[Auth] Wrong credentials"),n(u)})):(log.info("[Auth] MAuth header not presented"),n(u))};